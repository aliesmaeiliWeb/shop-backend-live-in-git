generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// 1. USER & AUTHENTICATION (OTP Logic)
// --------------------------------------

enum Role {
  USER
  ADMIN
  SHOP_MANAGER
}

model User {
  id                                                           String      @id @default(uuid())

  // Identity (Mobile is King)
  phoneNumber                                                  String      @unique
  email                                                        String?     @unique // Optional now
  password     String?   // Optional (only for admins usually)

  // Profile (Filled after login)
  name                                                         String?
  lastName                                                     String?
  avatar                                                       String?

  // Security (OTP)
  otpCode      String?   // Hashed code
  otpExpiresAt                                                 DateTime?
  isActive                                                     Boolean     @default(true)
  role                                                         Role        @default(USER)

  //                                                           Dates
  createdAt                                                    DateTime    @default(now())
  updatedAt                                                    DateTime    @updatedAt

  //                                                           Relations
  addresses                                                    Address[]
  orders                                                       Order[]
  cart                                                         Cart?
  wishlist                                                     WishList[]
  comments                                                     Comment[]

  // If this user owns a shop (Future feature)
  products     Product[] // Created by this user
}

model Address {
  id                                          String    @id @default(uuid())
  title      String? // e.g. "Home", "Office"
  street                                      String
  province                                    String
  city                                        String
  postalCode                                  String

  userId                                      String
  user                                        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt                                   DateTime  @default(now())
}

// --------------------------------------
// 2. PRODUCT & CATALOG (Commercial Grade)
// --------------------------------------

model Category {
  id        String      @id @default(uuid())
  name      String
  slug      String      @unique // SEO: /category/mobile-phones
  icon      String?
  imageUrl  String?
  isActive  Boolean     @default(true)

  // Sub-categories (Self Relation)
  parentId  String?
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")

  products  Product[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt @default(now())
}

model Product {
  id                                                                       String                 @id @default(uuid())
  name                                                                     String
  slug                                                                     String                 @unique // SEO: /product/nike-shoes-red

  shortDescription                                                         String?
  longDescription                                                          String?                @db.Text
  mainImage                                                                String

  gallery                                                                  ProductGallery[]

  // Base info (Logic is in SKUs, but we keep base price for display)
  basePrice                                                                Float                  @default(0)
  discountPercent                                                          Int?                   @default(0)

  isActive                                                                 Boolean                @default(true)

  isAmazing                                                                Boolean                @default(false)
  soldCount                                                                Int                    @default(0)

  deleteAt         DateTime? // If this has a date, the product is deleted

  categoryId                                                               String
  category                                                                 Category              @relation(fields: [categoryId], references: [id])

  //                                                                       Relations
  ownerId          String?      // The admin/shop who created it
  owner                                                                    User?                 @relation(fields: [ownerId], references: [id])

  skus             ProductSKU[] // The variants (Size/Color)
  comments                                                                 Comment[]
  wishlist                                                                 WishList[]
  attributes       ProductAttribute[] // Links attributes to this product

  priceHistory                                                             ProductPriceHistory[]

  createdAt                                                                DateTime               @default(now())
  updatedAt                                                                DateTime               @updatedAt
}

model ProductGallery {
  id        String    @id @default(uuid())
  imageUrl  String
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
}

// The actual sellable item (Example: T-Shirt Red XL)
model ProductSKU {
  id              String       @id @default(uuid())
  sku             String       @unique // The barcode/code
  price           Float
  quantity        Int          @default(0) // Stock
  discountPercent Int?         @default(0)

  productId       String
  product         Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  finalPrice      Float?

  //              Relations
  cartItems       CartItem[]
  orderItems      OrderItem[]

  deleteAt        DateTime?

  // Which attributes define this SKU? (JSON is easier for simple shops)
  // Example: { "color": "Red", "size": "XL" }
  attributesJson  Json?
}

model ProductPriceHistory {
  id                                          String    @id @default(uuid())
  productId                                   String
  product                                     Product  @relation(fields: [productId],references: [id], onDelete: Cascade)
  oldPrice                                    Float
  newPrice                                    Float
  changedBy String // admin id who changed it

  createdAt                                   DateTime  @default(now())
}

// Defining available attributes (Color, Size, Material)
model Attribute {
  id     String            @id @default(uuid())
  name   String            @unique // "Color"

  //     Relations
  values AttributeValue[]
}

model AttributeValue {
  id                                          String              @id @default(uuid())
  value       String    // "Red"
  colorCode   String?   // "#FF0000" (for UI)

  attributeId                                 String
  attribute                                   Attribute          @relation(fields: [attributeId], references: [id])

  productAttributes                           ProductAttribute[]
}

// Linking Products to Attributes (Many-to-Many)
model ProductAttribute {
  productId        String
  product          Product        @relation(fields: [productId], references: [id])

  attributeValueId String
  attributeValue   AttributeValue @relation(fields: [attributeValueId], references: [id])

  @@id([productId, attributeValueId])
}

// --------------------------------------
// 3. CART & ORDERS
// --------------------------------------

model Cart {
  id         String      @id @default(uuid())
  userId     String      @unique
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalPrice Float       @default(0)

  items      CartItem[]

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model CartItem {
  id           String      @id @default(uuid())
  cartId       String
  cart         Cart       @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productSKUId String
  productSKU   ProductSKU @relation(fields: [productSKUId], references: [id])

  quantity     Int         @default(1)

  @@unique([cartId, productSKUId])
}

enum OrderStatus {
  PENDING    
  PAID       
  PROCESSING 
  SHIPPED    
  DELIVERED 
  CANCELLED 
}

model Order {
  id                                                         String       @id @default(uuid())
  orderNumber                                                String       @unique // A readable ID like "ORD-2025-1001"

  userId                                                     String
  user                                                       User        @relation(fields: [userId], references: [id])

  addressJson                                                String       @db.Text
  note                                                       String?      @db.Text

  totalPrice                                                 Float
  discountAmount                                             Float        @default(0)
  shippingCost                                               Float        @default(0)
  finalPrice      Float       // Total - Discount + Shipping

  status                                                     OrderStatus  @default(PENDING)

  trackingCode                                               String?

  couponCode                                                 String?

  // Address Snapshot (We save the address as text, in case User changes it later)
  receiverName                                               String
  receiverPhone                                              String

  items                                                      OrderItem[]
  payment                                                    Payment?

  createdAt                                                  DateTime     @default(now())
  updatedAt                                                  DateTime     @updatedAt
}

model OrderItem {
  id           String       @id @default(uuid())
  orderId      String
  order        Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productSKUId String?
  productSKU   ProductSKU? @relation(fields: [productSKUId], references: [id], onDelete: SetNull)

  // Snapshot data (Save price at time of purchase!)
  productName  String
  skuCode      String
  quantity     Int
  image        String?
  price        Float
}

model Coupon {
  id          String    @id @default(uuid())
  code        String    @unique
  percent     Int
  maxDiscount Float?
  usageLimit  Int       @default(100)
  usedCount   Int       @default(0)
  expiresAt   DateTime
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
}

// --------------------------------------
// 4. EXTRAS (Comments, Wishlist, etc.)
// --------------------------------------

model Comment {
  id         String    @id @default(uuid())
  text       String
  rating     Int       @default(5)
  isApproved Boolean   @default(false)

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())
}

model WishList {
  userId    String
  productId String

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([userId, productId])
}

model Payment {
  id                                                String    @id @default(uuid())
  amount                                            Float
  gateway                                           String
  method        String?   // "ZarinPal", "Cash"
  resNumber     String?  // Reference ID from bank
  refId         String?  // Tracking code from bank
  status                                            Boolean   @default(false) // Success or Fail

  orderId                                           String    @unique
  order                                             Order    @relation(fields: [orderId], references: [id])

  createdAt                                         DateTime  @default(now())
}

enum BannerPosition {
  HOME_MAIN_SLIDER      
  HOME_MIDDLE_BANNER    
  HOME_BOTTOM_BANNER    
  PRODUCT_SIDEBAR       
  CATEGORY_HEADER
}

model Banner {
  id       String   @id @default(uuid())
  imageUrl String
  link     String?
  isActive Boolean  @default(true)

  position BannerPosition @default(HOME_MAIN_SLIDER)
}